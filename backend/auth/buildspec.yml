version: 0.2

env:
  variables:
    S3_BUCKET: foodstore-microservices-lambdas-functions
    ZIP_KEY: auth/lambda.zip
    LAMBDA_NAME: foodstore-auth-service

phases:
  install:
    commands:
      - echo "Incrementando límite de archivos abiertos..."
      - ulimit -n 4096
      - echo "Cambiando al directorio del microservicio..."
      - cd backend/auth
      - echo "Instalando dependencias para compilación..."
      - npm ci --no-audit --no-fund --maxsockets=1

  build:
    commands:
      - echo "Compilando Lambda..."
      - npm run build:lambda
      - echo "Copiando archivos necesarios al directorio de build..."
      - cp package.json package-lock.json .build-lambda/
      - cd .build-lambda
      - npm ci --omit=dev --no-audit --no-fund --maxsockets=1
      - echo "Empaquetando lambda.zip..."
      - zip -r lambda.zip .
      - cd ..

  post_build:
    commands:
      - echo "Subiendo a S3..."
      - aws s3 cp .build-lambda/lambda.zip s3://$S3_BUCKET/$ZIP_KEY
      - echo "Actualizando función Lambda..."
      - aws lambda update-function-code --function-name $LAMBDA_NAME --s3-bucket $S3_BUCKET --s3-key $ZIP_KEY

artifacts:
  files:
    - .build-lambda/lambda.zip
